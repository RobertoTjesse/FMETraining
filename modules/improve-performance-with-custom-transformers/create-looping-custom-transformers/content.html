<h2 id="custom-transformers-and-loops">
  <span>Custom Transformers and Loops</span>
</h2>
<p>A loop is a programming structure that allows an action to be implemented repeatedly. In most cases, a loop is linked to a condition; i.e., the action continues until a certain condition is met.</p>
<table class="featureTable sort_table">
  <tbody class="tbody">
    <tr>
      <td>FME Lizard says…</td>
    </tr>
    <tr>
      <td>As a broad example, an aircraft coming in to land often gets into a loop. It has to circle the airport again and again (the action) until it has clearance to land (the condition). Users who have flown into a busy airport will understand what I mean!</td>
    </tr>
  </tbody>
</table>
<p>An aircraft circles the airport as a delaying action. However, rarely in computing do we wish to slow processing. Instead, each iteration carries out a different action, or produces a slightly different result. Often each loop provides a closer and closer approximation of a solution, halting when it is within a set tolerance.</p>
<hr />
<h2 id="loops-and-fme">
  <span>Loops and FME</span>
</h2>
<p>In FME, loops are a way to repeat a section of transformers multiple times, without having to duplicate that section. For technical reasons, loops are only permitted inside a custom transformer.</p>
<p>As you know, FME processes one feature at a time. Therefore, when you create a loop, each feature is being sent around the loop <strong>individually</strong>.</p>
<p>So, to be worthwhile, each iteration of the loop must do something different. Often each iteration processes a different component of a feature (for example, reads records from a list) or repeats the same process using the results of the previous loop.</p>
<table class="featureTable sort_table">
  <tbody class="tbody">
    <tr>
      <td>FME Lizard says…</td>
    </tr>
    <tr>
      <td>It's stating the obvious I know, but you use a loop to repeat only actions that need repeating. One-off actions should take place outside of a loop. For example, here is an aircraft landing sequence:<br /><br /><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.054.CTFOTransformerLandingProcedure.png" class="image image-block image-center" /><br /><br />The "wheels down" part comes <strong>outside</strong> the circling loop because we don't want to raise/lower the wheels every time we circle the airport. That would be very inefficient.</td>
    </tr>
  </tbody>
</table>
<hr />
<h2 id="setting-up-a-custom-transformer-loop">
  <span>Setting up a Custom Transformer Loop</span>
</h2>
<p>A loop in a custom transformer requires various components. The required components are:</p>
<ul>
  <li>The start point of the loop</li>
  <li>The end point of the loop</li>
</ul>
<p>Other components relate to the conditions for ending the loop. At least one of these is required:</p>
<ul>
  <li>An absolute condition by which to test for the end of processing <em>("Circle the airport until I tell you")</em></li>
  <li>The number of times to carry out the loop <em>("Circle the airport five times, then land")</em></li>
  <li>A running count of the number of iterations <em>("I've circled the airport three times and have two more times to go")</em></li>
</ul>
<h2 id="loop-start-points">
  <span>Loop Start Points</span>
</h2>
<p>The start of the loop is identified by an Input port object. Although it can be the same input port as used for features to enter by, this does not have to be the case. For example, here there is an input port for features to arrive into, and another one for the start of the loop:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.055.CTLoopInputPort.png" alt class="image image-block image-center" /></p>
<p>This allows the loop point to be other than the beginning of the custom transformer.</p>
<p>By default, this second input port also appears on the transformer itself, like this:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.056.CTLoopInputPortOnCanvas.png" alt class="image image-block image-center" /></p>
<p>If you don't require this, then you simply have to 'unpublish' it in the input port's parameters:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.057.CTLoopInputPortUnpublish.png" alt class="image image-block image-center" /></p>
<hr />
<h2 id="loop-end-points">
  <span>Loop End Points</span>
</h2>
<p>The end of a loop is identified by a Loop object. You can insert one by selecting it from the canvas context menu in a custom transformer:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.058.CTInsertLoop.png" alt class="image image-block image-center" /></p>
<p>When a loop object is placed you are asked which Input object it is to be looped to:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.059.CTInsertLoopSelectInput.png" alt class="image image-block image-center" /></p>
<p>And then the loop is complete:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.060.CTCompletedLoop.png" alt class="image image-block image-center" /></p>
<p>Of course, this example is an infinite loop. The action is repeated, but there is no condition being tested to stop it. FME won't let an infinite loop run forever - it will recognize the problem and stop it - but we should set up something to force an ending.</p>
<hr />
<h2 id="loop-conditions">
  <span>Loop Conditions</span>
</h2>
<p>There are two general types of condition for which we can test. Firstly we can loop a set number of times. Secondly, we can loop until a specific condition is met.</p>
<p>Here is a custom transformer that loops a set number of times:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.061.CTLoopCounterCondition.png" alt class="image image-block image-center" /></p>
<p>Notice that we have an attribute that is a counter for the number of times we have looped (<em>LoopCounter</em>), and an attribute that tells us the maximum number of loops to carry out (<em>MaxLoops</em>).</p>
<p>In each loop, the counter attribute is incremented by 1. When <em>LoopCounter &lt; MaxLoops</em>, then we loop back and process the data again. When <em>LoopCounter = MaxLoops</em>, then we exit the transformer.</p>
<p>Instead of a simple count of iterations, another method is to test a specific measure of data quality. For example, here an ellipse representing a park is adjusted (resized smaller and smaller) until it's size is less than a certain quantity:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.065.CTLoopExampleImage.png" alt class="image image-block image-center" /></p>
<hr />
<table class="featureTable sort_table">
  <tbody class="tbody">
    <tr>
      <td>FME Lizard says…</td>
    </tr>
    <tr>
      <td>For an excellent, real-world example of looping in an FME workspace, check out <a href="http://www.fme.ly/LoopExample" rel="noreferrer noopener" target="_blank"><strong>this customer story</strong></a>.<br /><br />In that example, the user uses a loop to place trees (the action) until a specific density is reached (the condition). Notice that the loop is not tied to a specific counter - it continues until the data quality required is met.</td>
    </tr>
  </tbody>
</table>
<hr />
<h2 id="loops-and-transformer-types">
  <span>Loops and Transformer Types</span>
</h2>
<p>As you should already know, transformers that operate on one feature at a time are called Feature-Based, and transformers that operate on multiple features at a time are called Group-Based.</p>
<p>We can also call a loop "Feature-Based" because it only processes one feature at a time. Unfortunately, that means that using a group-based transformer inside a (feature-based) custom transformer loop is not a simple task.</p>
<p>If you attempt to create a loop inside an embedded custom transformer, when it includes a group-based FME transformer, then you receive an error message. Group-based transformers are only permitted inside a loop in a linked custom transformer. There are technical reasons for this that we won't go into right now.</p>
<p>This is the error message you get:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.062.CTLoopWithBlockingMessage.png" alt class="image image-block image-center" /></p>
<p>So, inside a linked custom transformer definition, you'll see a particular parameter (in the Navigator window) called Enable Blocked Looping:</p>
<p><img src="https://s3.amazonaws.com/gitbook/Desktop-Advanced-2019/DesktopAdvanced5CustomTransformers/Images/Img5.063.CTLoopWithBlockingParameter.png" alt class="image image-block image-center" /></p>
<p>When set to Yes then other parameters allow you to set the number of iterations, and to set an attribute that will hold that value. Parallel processing is turned off (the parameters are removed) for custom transformers that are being looped, and the Insert Mode is automatically changed to "Linked Only".</p>
<hr />
<table class="featureTable sort_table">
  <tbody class="tbody">
    <tr>
      <td>FME Lizard asks...</td>
    </tr>
    <tr>
      <td>
        <p>Q) Which of these statements about loops are true?</p>Loops are only permitted inside a custom transformerA loop without a condition will continue processing until manually stoppedTest conditions are built into the loop end point parametersNested loops (a loop within a loop) are permitted
      </td>
    </tr>
  </tbody>
</table>